/* ==========================================================
   PROJECT: SOURYANOVA
   ========================================================== */

// 1. TEMPLATE INFO (MATCHING YOUR SCREENSHOTS)
#define BLYNK_TEMPLATE_ID "addN/A"
#define BLYNK_TEMPLATE_NAME "addN/A"
#define BLYNK_AUTH_TOKEN "addN/A"

#define BLYNK_PRINT Serial
#include <WiFi.h>
#include <BlynkSimpleEsp32.h>
#include <ESP32Servo.h>
#include <Wire.h>
#include <Adafruit_INA219.h>

// --- CRITICAL SETTING: FORCE DATA ON ---
// Set this to true so the dashboard always shows numbers (580mA)
bool DEMO_MODE = true; 

char ssid[] = "addN/A";  
char pass[] = "addN/A";   

// --- PINS ---
#define SWEEP_SERVO_PIN 26
#define SERVO360_PIN    27
#define LDR_PIN         35

// --- OBJECTS ---
Servo sweepServo;
Servo servo360;
Adafruit_INA219 ina219;

// --- VARIABLES ---
int sweepEnable = 0;
int platformEnable = 0;
int manualDust = 0;
int sweepPos = 0;
int sweepDir = 1;
int servo360Neutral = 90; 
int deadZone = 8;

unsigned long t_Sensor = 0;
unsigned long t_Servo  = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("\n=== SYSTEM STARTING ===");

  // Motors
  ESP32PWM::allocateTimer(0);
  ESP32PWM::allocateTimer(1);
  sweepServo.setPeriodHertz(50);
  sweepServo.attach(SWEEP_SERVO_PIN, 500, 2400);
  servo360.setPeriodHertz(50);
  servo360.attach(SERVO360_PIN, 500, 2400);

  // Sensors
  Wire.begin();
  if(!ina219.begin()) Serial.println("INA219 Not Found (Using Simulation)");
  pinMode(LDR_PIN, INPUT);

  // WiFi
  WiFi.begin(ssid, pass);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi Connected.");

  Blynk.config(BLYNK_AUTH_TOKEN, "blynk.cloud", 80);
  Blynk.connect();
}

void loop() {
  if (WiFi.status() == WL_CONNECTED && Blynk.connected()) {
    Blynk.run();
  }

  // ---- SEND DATA EVERY 1 SECOND ----
  if (millis() - t_Sensor > 1000) {
    t_Sensor = millis();

    // 1. GET DATA (Simulated or Real)
    double current_val = 0.0;
    double power_val = 0.0;

    if (DEMO_MODE) {
      // Generate stable number (approx 580.50 mA)
      // We use double to match your Datastream setting
      current_val = 580.0 + (random(0, 50) / 10.0); 
      power_val = current_val * 12.0;
    } else {
      // Real sensor
      current_val = ina219.getCurrent_mA();
      power_val = ina219.getPower_mW();
      if (current_val < 0) current_val = 0;
    }
    
    int rawLdr = analogRead(LDR_PIN);

    // 2. LOGIC: Slider V1 > 70 triggers Wiper
    if (manualDust > 70) {
      sweepEnable = 1;
      if(Blynk.connected()) Blynk.virtualWrite(V0, 1);
    } else {
      sweepEnable = 0;
      if(Blynk.connected()) Blynk.virtualWrite(V0, 0);
    }

    // 3. FORCE SERIAL PRINT
    Serial.print("[DATA] V1: "); Serial.print(manualDust);
    Serial.print("% | V2(Curr): "); Serial.print(current_val);
    Serial.print(" mA | V3(Pwr): "); Serial.print(power_val); Serial.println(" mW");

    // 4. SEND TO BLYNK
    // Your datastreams are DOUBLE, so we send simple numbers.
    if (Blynk.connected()) {
      Blynk.virtualWrite(V2, current_val); 
      Blynk.virtualWrite(V3, power_val);   
      Blynk.virtualWrite(V6, rawLdr);
      
      String status = (manualDust > 70) ? "CLEANING..." : "MONITORING";
      Blynk.virtualWrite(V5, status);
    }
  }

  // ---- MOTORS ----
  if (sweepEnable == 1) {
    if (millis() - t_Servo > 15) {
      t_Servo = millis();
      sweepServo.write(sweepPos);
      sweepPos += sweepDir;
      if (sweepPos >= 180) sweepDir = -1;
      if (sweepPos <= 0)   sweepDir = 1;
    }
  } else {
    if (millis() - t_Servo > 15 && sweepPos > 0) {
      t_Servo = millis();
      sweepPos--;
      sweepServo.write(sweepPos);
    }
  }
}

// ---- BLYNK INPUTS ----
BLYNK_WRITE(V1) { manualDust = param.asInt(); }
BLYNK_WRITE(V0) { if(manualDust <= 70) sweepEnable = param.asInt(); }
BLYNK_WRITE(V9) { platformEnable = param.asInt(); if(!platformEnable) servo360.write(90); }
BLYNK_WRITE(V4) { 
  int val = param.asInt();
  if(platformEnable) servo360.write(val); 
  else servo360.write(90);
}
